# Filename: {{ output_path }}
# Borgmatic configuration for backing up {{ backup_name }}
# Generated by Scaffoldr on {{ generation_timestamp }}

location:
    source_directories:
        - {{ source_directory }}

    repositories:
        - {{ repository_path }}

{%- if exclude_patterns %}

    exclude_patterns:
    {%- for pattern in exclude_patterns %}
        - '{{ pattern }}'
    {%- endfor %}
{%- endif %}

{%- if remote_path %}

    remote_path: {{ remote_path }}
{%- endif %}

{%- set archive_prefix = archive_name_format if archive_name_format else backup_name %}

storage:
    archive_name_format: '{{ archive_prefix }}-{now:%Y-%m-%d_%H:%M:%S}'
    {%- if encryption_passphrase %}
    encryption_passphrase: '{{ encryption_passphrase }}'
    {%- else %}
    encryption_passphrase: ''
    {%- endif %}
    relocated_repo_access_is_ok: true

retention:
    prefix: '{{ archive_prefix }}'
    keep_daily: {{ retention_daily }}
    keep_weekly: {{ retention_weekly }}
    keep_monthly: {{ retention_monthly }}
    keep_yearly: {{ retention_yearly }}
{%- if retention_hourly and retention_hourly|int > 0 %}
    keep_hourly: {{ retention_hourly }}
{%- endif %}

consistency:
    checks:
{%- if consistency_checks and 'none' not in consistency_checks %}
    {%- for check in consistency_checks %}
        - {{ check }}
    {%- endfor %}
{%- else %}
        []
{%- endif %}

hooks:
    before_backup:
        - echo "Starting backup for '{{ backup_name }}'..."

    after_backup:
        - echo "Backup for '{{ backup_name }}' complete."
        - borg compact {% if remote_path %}--remote-path={{ remote_path }}{% endif %} {{ repository_path }}

    on_error:
        - echo "An error occurred during the '{{ backup_name }}' backup."

